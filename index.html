<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trang m·∫≠t kh·∫©u ‚Üí Trung Thu (video fullscreen) ‚Üí L·ªùi ch√∫c</title>
  <style>
    :root{
      --bg:#fff8d3;
      --card:#0b1220;
      --accent:#06b6d4;
      --muted:#3b3b3b;
      --holo:#ffd54f;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter, system-ui, Arial, sans-serif;background:linear-gradient(180deg,#fff8d3 0%, #ffd366 100%);color:#1a1a1a;display:flex;align-items:center;justify-content:center;padding:0}

    /* Card */
    .card{width:min(96vw,1200px);height:min(86vh,860px);background:var(--card);padding:12px;border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,0.7);color:#e6eef6;display:flex;flex-direction:column;gap:8px;position:relative}

    .page{position:relative;flex:1;display:flex;flex-direction:column}
    .page.hidden{display:none}

    /* ===== Page 1 (password) - background image ===== */
    .pw-holo{
      position:relative;
      border-radius:12px;
      padding:18px;
      flex:1;
      display:flex;
      flex-direction:column;
      justify-content:center;
      overflow:hidden;
      color:#fff8e6;
      text-shadow:0 2px 8px rgba(0,0,0,0.6);

      /* ∆∞u ti√™n load ·∫£nh online; fallback sang file local n·∫øu c·∫ßn */
      background-image:
        linear-gradient(135deg, rgba(11,18,32,0.45), rgba(11,18,32,0.25)),
        url('https://png.pngtree.com/background/20210714/original/pngtree-mid-autumn-festival-green-classical-background-picture-image_1219098.jpg');
      background-size: cover, cover;
      background-position: center, center;
      background-repeat: no-repeat;
      box-shadow:0 6px 20px rgba(0,0,0,0.45) inset;
      border:1px solid rgba(255,210,90,0.04);
    }

    /* khung ch·ª©a n·ªôi dung m·∫≠t kh·∫©u */
    .pw-box{
      margin:auto; /* gi√∫p cƒÉn gi·ªØa trong flex */
      padding:28px 24px;
      border-radius:12px;
      background:rgba(0,0,0,0.45); /* n·ªÅn m·ªù t√°ch kh·ªèi ·∫£nh */
      backdrop-filter:blur(6px);
      box-shadow:0 6px 18px rgba(0,0,0,0.35);
      max-width:520px;
      text-align:center;
    }
    .pw-box .title{
      font-size:22px;
      font-weight:700;
      color:var(--holo);
      margin-bottom:14px;
    }

    input[type="password"], input[type="text"]{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:inherit;margin-bottom:12px}
    button{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),#7c3aed);color:#001021;font-weight:600;cursor:pointer}
    .muted{color:var(--muted);font-size:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}

    /* small header buttons */
    .header-actions{position:absolute;right:14px;top:12px;display:flex;gap:8px;z-index:100}
    .small-btn{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}

    /* modal for visitor list */
    .modal{
      position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(92vw,900px);max-height:80vh;overflow:auto;background:linear-gradient(180deg, rgba(11,18,32,0.98), rgba(11,18,32,0.96));border-radius:12px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,0.6);z-index:999;display:none;
    }
    .modal.open{display:block}
    .modal h3{margin:0 0 10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 6px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left;font-size:14px;color:rgba(255,255,255,0.9)}
    .status-ok{color:#7ef3a6;font-weight:600}
    .status-wrong{color:#ff9a9a;font-weight:600}
    .status-pending{color:#ffd56b;font-weight:600}

    /* rotation overlay */
    #rotateOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);color:#fff;display:flex;align-items:center;justify-content:center;z-index:60;padding:20px;flex-direction:column;gap:12px;text-align:center}
    #rotateOverlay.hidden{display:none}
    @media (min-width:900px){ #rotateOverlay{display:none} }

    /* Video area */
    .video-full{flex:1;display:flex;align-items:center;justify-content:center;border-radius:10px;overflow:hidden;background:#000}
    .video-full iframe, .video-full > div{width:100%;height:100%;border:0}

    /* Continue button */
    #nextBtnContainer{position:absolute;left:50%;transform:translateX(-50%);bottom:26px;z-index:40}
    #nextBtnContainer.hidden{display:none}

    /* ===== Page 3 (greeting) ===== */
    .page#page-greeting{
      background-image:
        linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0.06)),
        url('https://upload.urbox.vn/strapi-mobile/medium_tet_trung_thu_feature_image_1_bc298a6819_50e2ccb958_96563ba48a.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      border-radius:12px;
      overflow:hidden;
      padding:18px;
      position:relative; /* important for absolute lanterns */
    }

    .greeting{
      font-size:34px;
      text-align:center;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      height:100%;
      position:relative;
      overflow:visible;
    }

    .greeting-content{
      padding:36px 28px;
      border-radius:14px;
      background:rgba(0,0,0,0.45); /* n·ªÅn m·ªù */
      backdrop-filter: blur(6px);
      box-shadow:0 6px 18px rgba(0,0,0,0.35);
      max-width:80%;
      position:relative;
      z-index:10;
    }

    .lanterns{pointer-events:none;position:absolute;inset:0;z-index:999;overflow:hidden}
    .lantern{position:absolute;bottom:-30%;width:88px;height:132px;aspect-ratio:2/3;opacity:0;will-change:transform,opacity;transform-origin:center bottom;background-repeat:no-repeat;background-size:contain;background-position:center;pointer-events:none}
    .lantern.v1{animation:lanternUp 9.6s linear infinite;filter:drop-shadow(0 10px 22px rgba(0,0,0,0.35))} .lantern.v2{animation:lanternUp 11.4s linear infinite} .lantern.v3{animation:lanternUp 10.2s linear infinite} .lantern.v4{animation:lanternUp 12.2s linear infinite} .lantern.v5{animation:lanternUp 10.8s linear infinite}
    @keyframes lanternUp{0%{transform:translateX(0) translateY(0) rotate(-6deg) scale(var(--s,1));opacity:0}6%{opacity:1}30%{transform:translateX(var(--dx,0px)) translateY(-30vh) rotate(6deg) scale(calc(var(--s,1)*1.03));opacity:0.95}60%{transform:translateX(calc(var(--dx,0px)*1.15)) translateY(-62vh) rotate(-8deg) scale(calc(var(--s,1)*0.98));opacity:0.7;filter:blur(0.6px)}100%{transform:translateX(calc(var(--dx,0px)*1.3)) translateY(-120vh) rotate(-10deg) scale(var(--s,1));opacity:0}}
    @media (max-width:720px){ .lantern{width:56px;height:84px} } @media (max-width:520px){ .card{height:92vh} }
    @media (prefers-reduced-motion: reduce){ .lantern{animation:none !important; opacity:1 !important; transform:none !important} }

    .muted-small{font-size:12px;color:rgba(255,255,255,0.75)}
  </style>
</head>
<body>

  <div id="rotateOverlay" class="hidden" role="dialog" aria-modal="true">
    <div class="box">
      <h2>Xoay m√†n h√¨nh sang ngang ƒë·ªÉ tr·∫£i nghi·ªám t·ªët h∆°n</h2>
      <p>ƒê·ªÉ video hi·ªÉn th·ªã ƒë√∫ng t·ªâ l·ªá ngang v√† to√†n m√†n h√¨nh, h√£y xoay thi·∫øt b·ªã sang ch·∫ø ƒë·ªô ngang (landscape).</p>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:10px">
        <button id="tryLockBtn" class="rotateBtn">Th·ª≠ kh√≥a ngang</button>
        <button id="dismissRotate" style="background:transparent;border:1px solid rgba(255,255,255,0.12);color:#fff;padding:10px 12px;border-radius:10px">ƒê√£ hi·ªÉu</button>
      </div>
    </div>
  </div>

  <div class="card" id="mainCard">
    

    <!-- Page 1: password with name -->
    <div id="page-password" class="page pw-holo">
      <div class="pw-box">
        <div class="title">Nh·∫≠p t√™n & m·∫≠t kh·∫©u ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>
        <p class="muted" style="color:rgba(255,255,255,0.9)">Vui l√≤ng ghi t√™n b·∫°n ·ªü √¥ d∆∞·ªõi, sau ƒë√≥ nh·∫≠p m·∫≠t kh·∫©u.</p>

        <!-- NEW: name field -->
        <input id="visitorName" type="text" placeholder="T√™n c·ªßa b·∫°n..." autocomplete="off" />

        <!-- existing password field -->
        <input id="pw" type="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." autocomplete="off" />
        <div class="row" style="margin-top:6px;justify-content:center">
          <button id="btnEnter">B·∫Øt ƒë·∫ßu</button>
          <button id="btnHint" style="background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04)">G·ª£i √Ω</button>
        </div>
        <p id="pwMsg" class="muted" style="margin-top:10px;color:rgba(255,255,255,0.85)"></p>
        
      </div>
    </div>

    <!-- Page 2: video fullscreen inside card -->
    <div id="page-video" class="page hidden" style="position:relative">
      <div class="video-full" id="videoFull">
        <!-- YouTube player will be injected here by API -->
        <div id="player"></div>
      </div>

      <div id="nextBtnContainer" class="hidden">
        <button id="btnNext">Ti·∫øp t·ª•c</button>
      </div>

      <div style="position:absolute;right:12px;top:12px;z-index:50"><button id="btnBackToPw" style="background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04)">Quay l·∫°i</button></div>
    </div>

    <!-- Page 3: greeting -->
    <div id="page-greeting" class="page hidden">

      <div class="greeting">
        <div class="greeting-content">
          <h1>üåï‚ú® Ch√∫c b·∫°n v√† gia ƒë√¨nh Trung Thu vui v·∫ª! ‚ú®üåï</h1>
        </div>
      </div>

      <!-- lanterns: placed AFTER greeting-content so z-index behaves predictably -->
      <div class="lanterns" id="lanterns" aria-hidden="true"></div>

    </div>

  </div>

  <!-- visitor list modal -->
  <div id="visitorModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <h3>Danh s√°ch kh√°ch ƒë√£ ghi t√™n</h3>
    <div style="overflow:auto;">
      <table id="visitorTable" role="table" aria-label="Danh s√°ch kh√°ch">
        <thead><tr><th>#</th><th>T√™n</th><th>Th·ªùi gian</th><th>K·∫øt qu·∫£</th><th>Synced</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="btnCloseModal" class="small-btn">ƒê√≥ng</button>
      <button id="btnClearList" class="small-btn">X√≥a danh s√°ch</button>
      <button id="btnDownloadCsv" class="small-btn">T·∫£i CSV</button>
    </div>
    <p style="margin-top:10px;color:rgba(255,255,255,0.75);font-size:13px">L∆∞u √Ω: d·ªØ li·ªáu hi·ªán l∆∞u tr√™n tr√¨nh duy·ªát (localStorage). ƒê·ªÉ l∆∞u t·∫≠p trung, c·∫•u h√¨nh REMOTE_ENDPOINT trong m√£.</p>
  </div>

  <!-- YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    // ---------- CONFIG ----------
    const PASSWORD = '11223344';
    const VIDEO_ID = 'gL5pDe7cqco';
    const NEXT_DELAY_RATIO = 2/3; // show button after 2/3 of video
    const AUTO_RETURN_MS = 30000;

    // REMOTE: d√°n URL Web App (Apps Script) c·ªßa b·∫°n v√†o REMOTE_ENDPOINT
    // B·∫°n ƒë√£ c√≥ Web App URL; n·∫øu mu·ªën g·ª≠i l√™n server, ƒëi·ªÅn URL v√† ƒëi·ªÅn REMOTE_SECRET gi·ªëng EXPECTED_SECRET b√™n Apps Script
    const REMOTE_ENDPOINT = 'hthttps://script.google.com/macros/s/AKfycbweZpSuita7e-2T4HOrT40l9A0wHGZnF8onM1t_xV0fAhdvyPT3YelweMuv82-ZiOkN/exectps://script.google.com/macros/s/AKfycbyKV3Yvy2_Q3I5ieLRD84iNrbmA3QBlWvQ9phKqfufeYFOwE5EbV5cGtVjSIbcNrQrY/exec';
    const REMOTE_SECRET   = 's3cR3tXyZ_2025'; // <-- **thay b·∫±ng chu·ªói b√≠ m·∫≠t b·∫°n ch·ªçn** (ph·∫£i kh·ªõp Apps Script)

    // localStorage key
    const STORAGE_KEY = 'trungthu_visitors_v1';

    // SVG lantern data URI (shortened body for brevity ‚Äî full earlier svg also works)
    const LANTERN_SRC = 'data:image/svg+xml;utf8,' + encodeURIComponent(`
<svg xmlns="http://www.w3.org/2000/svg" width="200" height="300" viewBox="0 0 200 300"> ... </svg>
    `);

    // ---------- Elements ----------
    const rotateOverlay = document.getElementById('rotateOverlay');
    const tryLockBtn = document.getElementById('tryLockBtn');
    const dismissRotate = document.getElementById('dismissRotate');

    const pagePw = document.getElementById('page-password');
    const pageVideo = document.getElementById('page-video');
    const pageGreeting = document.getElementById('page-greeting');

    const visitorName = document.getElementById('visitorName');
    const pwInput = document.getElementById('pw');
    const btnEnter = document.getElementById('btnEnter');
    const btnHint = document.getElementById('btnHint');
    const pwMsg = document.getElementById('pwMsg');

    const nextBtnContainer = document.getElementById('nextBtnContainer');
    const btnNext = document.getElementById('btnNext');
    const btnBackToPw = document.getElementById('btnBackToPw');
    const mainCard = document.getElementById('mainCard');

    const btnShowList = document.getElementById('btnShowList');
    const visitorModal = document.getElementById('visitorModal');
    const visitorTableBody = document.querySelector('#visitorTable tbody');
    const btnCloseModal = document.getElementById('btnCloseModal');
    const btnClearList = document.getElementById('btnClearList');
    const btnDownloadCsv = document.getElementById('btnDownloadCsv');
    const btnExportAll = document.getElementById('btnExportAll');

    // YouTube player
    let player = null;
    let checkInterval = null;
    let autoReturnTimeout = null;

    // ---------- Visitor storage helpers ----------
    function loadVisitors(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      }catch(e){ console.warn('loadVisitors err', e); return []; }
    }
    function saveVisitors(list){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }catch(e){ console.warn('saveVisitors err', e); }
    }

    function renderVisitorTable(){
      const list = loadVisitors();
      visitorTableBody.innerHTML = '';
      if(!list.length){
        const tr = document.createElement('tr');
        const td = document.createElement('td'); td.colSpan = 5; td.textContent = 'Danh s√°ch tr·ªëng'; td.style.color = 'var(--muted)';
        tr.appendChild(td); visitorTableBody.appendChild(tr);
        return;
      }
      list.forEach((v, idx) => {
        const tr = document.createElement('tr');
        const no = document.createElement('td'); no.textContent = (idx+1);
        const nameTd = document.createElement('td'); nameTd.textContent = v.name;
        const timeTd = document.createElement('td'); timeTd.textContent = (new Date(v.time)).toLocaleString();
        const resTd = document.createElement('td'); resTd.textContent = v.result === 'ok' ? 'OK' : (v.result === 'wrong' ? 'Sai m·∫≠t kh·∫©u' : v.result);
        const synTd = document.createElement('td'); synTd.textContent = v.synced ? 'OK' : 'Ch∆∞a';
        synTd.className = v.synced ? 'status-ok' : 'status-pending';
        tr.appendChild(no); tr.appendChild(nameTd); tr.appendChild(timeTd); tr.appendChild(resTd); tr.appendChild(synTd);
        visitorTableBody.appendChild(tr);
      });
    }

    function downloadCSV(){
      const list = loadVisitors().slice().reverse(); // oldest first
      if(!list.length){ alert('Danh s√°ch tr·ªëng'); return; }
      const rows = [['T√™n','Th·ªùi gian (ISO)','K·∫øt qu·∫£','UserAgent','Synced']];
      list.forEach(r => rows.push([ `"${r.name.replace(/"/g,'""')}"`, r.time, r.result, `"${(r.ua||'').replace(/"/g,'""')}"`, r.synced ? 'true' : 'false' ]));
      const csv = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'visitors.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // addVisitor: save local + send remote (with secret), mark synced on success
    // addVisitor: save local + send remote (with secret), mark synced on success
function addVisitor(name, result){
  const list = loadVisitors();
  const entry = {
    name: name || '(kh√¥ng t√™n)',
    time: new Date().toISOString(),
    result,
    ua: navigator.userAgent || '',
    synced: false
  };
  list.unshift(entry);
  saveVisitors(list);
  renderVisitorTable();

  // G·ª≠i remote n·∫øu c√≥ c·∫•u h√¨nh
  if (REMOTE_ENDPOINT && REMOTE_SECRET && REMOTE_SECRET !== 'REPLACE_WITH_YOUR_SECRET') {
    const payload = { 
      secret: REMOTE_SECRET,   // ‚úÖ b·∫Øt bu·ªôc c√≥ secret
      name: entry.name, 
      result: entry.result, 
      ua: entry.ua 
    };

    fetch(REMOTE_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(async res => {
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const j = await res.json().catch(()=>null);

      if (j && j.status && j.status.toLowerCase() === 'ok') {
        // ƒê√°nh d·∫•u entry ƒë√£ ƒë·ªìng b·ªô
        const cur = loadVisitors();
        const idx = cur.findIndex(it => it.time === entry.time && it.name === entry.name);
        if (idx !== -1) {
          cur[idx].synced = true;
          saveVisitors(cur);
          renderVisitorTable();
        }
      } else {
        console.warn('Remote save responded but not OK', j);
      }
    })
    .catch(err => {
      console.warn('Remote save failed', err);
      // Gi·ªØ l·∫°i local, s·∫Ω retry khi load l·∫°i
    });
  }
}


    // retry unsynced entries on load (sequential)
    function retryUnsynced(){
      const list = loadVisitors();
      if(!list.length || !REMOTE_ENDPOINT || !REMOTE_SECRET || REMOTE_SECRET === 'REPLACE_WITH_YOUR_SECRET') return;
      const pending = list.slice().reverse().filter(it => !it.synced);
      if(!pending.length) return;
      (async function sendSeq(){
        for(const e of pending){
          try{
            const payload = { name: e.name, result: e.result, ua: e.ua, secret: REMOTE_SECRET };
            const res = await fetch(REMOTE_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
            if(!res.ok) throw new Error('HTTP '+res.status);
            const j = await res.json().catch(()=>null);
            if(j && j.status && j.status.toLowerCase() === 'ok'){
              const cur = loadVisitors();
              const idx = cur.findIndex(it => it.time === e.time && it.name === e.name);
              if(idx !== -1){ cur[idx].synced = true; saveVisitors(cur); }
            }
          }catch(err){
            console.warn('retry failed for', e, err);
          }
        }
        renderVisitorTable();
      })();
    }

    // ---------- Orientation helpers ----------
    function checkOrientationAndPrompt(){
      const isPortrait = window.matchMedia('(orientation: portrait)').matches;
      const narrow = window.matchMedia('(max-width:900px)').matches;
      if(pagePw && !pagePw.classList.contains('hidden')){
        if(isPortrait && narrow){ rotateOverlay.classList.remove('hidden'); } else { rotateOverlay.classList.add('hidden'); }
      } else {
        rotateOverlay.classList.add('hidden');
      }
    }
    async function tryLockLandscape(){
      try { if(screen.orientation && screen.orientation.lock){ await screen.orientation.lock('landscape'); rotateOverlay.classList.add('hidden'); return true; } }
      catch(e){ console.warn('Kh√¥ng th·ªÉ kh√≥a h∆∞·ªõng:', e); }
      return false;
    }
    dismissRotate.addEventListener('click', ()=>{ rotateOverlay.classList.add('hidden'); });
    tryLockBtn.addEventListener('click', async ()=>{ const ok = await tryLockLandscape(); if(!ok) alert('Tr√¨nh duy·ªát kh√¥ng cho ph√©p kh√≥a h∆∞·ªõng ‚Äî xoay thi·∫øt b·ªã th·ªß c√¥ng.'); });
    function setupGestureLock(){ const gesture = ()=>{ tryLockLandscape(); window.removeEventListener('touchstart', gesture); window.removeEventListener('click', gesture); }; window.addEventListener('touchstart', gesture, {passive:true}); window.addEventListener('click', gesture); }

    // --- YouTube player setup ---
    function onYouTubeIframeAPIReady(){
      player = new YT.Player('player', {
        height: '100%', width: '100%', videoId: VIDEO_ID,
        playerVars: { 'playsinline': 1, 'rel': 0, 'showinfo': 0 },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        }
      });
    }
    function onPlayerReady(event){ /* nothing yet */ }
    function onPlayerStateChange(e){
      if(e.data === YT.PlayerState.ENDED){ showContinueButton(); }
    }

    function startAndMonitorVideo(){
      if(!player) return;
      try{ player.playVideo(); }catch(e){ console.warn('playVideo failed', e); }
      requestFullscreenFor(mainCard);
      clearInterval(checkInterval);
      checkInterval = setInterval(()=>{ try{
          const dur = player.getDuration();
          const cur = player.getCurrentTime();
          if(dur > 0 && cur/dur >= NEXT_DELAY_RATIO){ showContinueButton(); }
        }catch(e){ }
      }, 500);
    }
    function showContinueButton(){ nextBtnContainer.classList.remove('hidden'); if(checkInterval) clearInterval(checkInterval); }
    function stopAndCleanupVideo(){ try{ if(player && player.stopVideo) player.stopVideo(); }catch(e){} if(checkInterval) clearInterval(checkInterval); nextBtnContainer.classList.add('hidden'); exitFullscreenIfAny(); }

    async function requestFullscreenFor(el){
      try{
        if(el.requestFullscreen) await el.requestFullscreen();
        else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        else if(el.msRequestFullscreen) el.msRequestFullscreen();
      }catch(e){ console.warn('Fullscreen request failed', e); }
    }
    async function exitFullscreenIfAny(){
      try{ if(document.fullscreenElement) await document.exitFullscreen(); }
      catch(e){ /* ignore */ }
    }

    // Page flow
    function showPage(name){
      pagePw.classList.add('hidden'); pageVideo.classList.add('hidden'); pageGreeting.classList.add('hidden');
      if(name==='pw') pagePw.classList.remove('hidden');
      if(name==='video') pageVideo.classList.remove('hidden');
      if(name==='greeting'){
        pageGreeting.classList.remove('hidden');
        prepareGreetingVisuals();
      }
      checkOrientationAndPrompt();
    }

    btnEnter.addEventListener('click', ()=>{
      const nameVal = (visitorName.value || '').trim();
      const pwVal = (pwInput.value || '').trim();
      if(!nameVal){ pwMsg.textContent = 'Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n tr∆∞·ªõc.'; visitorName.focus(); return; }
      if(pwVal === PASSWORD){
        addVisitor(nameVal, 'ok');
        pwMsg.textContent = '';
        showPage('video');
        startAndMonitorVideo();
      } else {
        addVisitor(nameVal, 'wrong');
        pwMsg.textContent = 'M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng ‚Äî ƒë√£ ghi nh·∫≠n t√™n (n·∫øu b·∫°n mu·ªën th·ª≠ l·∫°i, nh·∫≠p m·∫≠t kh·∫©u l·∫°i).';
      }
      pwInput.value = '';
    });

    btnNext.addEventListener('click', ()=>{ stopAndCleanupVideo(); showGreeting(); });
    btnBackToPw.addEventListener('click', ()=>{ stopAndCleanupVideo(); showPage('pw'); visitorName.value=''; pwInput.value=''; pwMsg.textContent=''; clearAutoReturn(); });

    function showGreeting(){
      showPage('greeting');
      clearAutoReturn();
      autoReturnTimeout = setTimeout(()=>{ showPage('pw'); visitorName.value=''; pwInput.value=''; pwMsg.textContent=''; }, AUTO_RETURN_MS);
    }
    function clearAutoReturn(){ if(autoReturnTimeout) clearTimeout(autoReturnTimeout); }

    // visitor modal
    btnShowList.addEventListener('click', ()=>{ renderVisitorTable(); visitorModal.classList.add('open'); visitorModal.setAttribute('aria-hidden','false'); });
    btnCloseModal.addEventListener('click', ()=>{ visitorModal.classList.remove('open'); visitorModal.setAttribute('aria-hidden','true'); });
    btnClearList.addEventListener('click', ()=>{ if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô danh s√°ch kh√°ch tr√™n tr√¨nh duy·ªát n√†y?')){ localStorage.removeItem(STORAGE_KEY); renderVisitorTable(); alert('ƒê√£ x√≥a danh s√°ch (local).'); }});
    btnDownloadCsv.addEventListener('click', downloadCSV);
    btnExportAll.addEventListener('click', downloadCSV);

    // lanterns visuals
    async function createLanterns(count = 7){
      const container = document.getElementById('lanterns');
      if(!container) return;
      container.innerHTML = '';
      const src = LANTERN_SRC;
      for (let i=0;i<count;i++){
        const el = document.createElement('div');
        el.className = 'lantern v' + ((i%5)+1);
        const left = 6 + Math.random()*88;
        el.style.left = `${left}%`;
        const dx = (Math.random()*160 - 80).toFixed(1) + 'px';
        el.style.setProperty('--dx', dx);
        const s = (0.8 + Math.random()*0.6).toFixed(2);
        el.style.setProperty('--s', s);
        el.style.animationDelay = (Math.random()*-10).toFixed(2) + 's';
        el.style.backgroundImage = `url("${src}")`;
        container.appendChild(el);
      }
    }
    function ensureLanternsCreated(){ if(document.getElementById('lanterns') && !document.getElementById('lanterns').children.length) createLanterns(8); }
    function prepareGreetingVisuals(){ ensureLanternsCreated(); const lanterns = document.querySelectorAll('.lantern'); lanterns.forEach((l,idx)=>{ l.style.transition = 'filter 0.6s ease'; setTimeout(()=> l.style.filter = 'drop-shadow(0 16px 36px rgba(255,160,50,0.35))', 300 + idx*80); setTimeout(()=> l.style.filter = '', 2600 + idx*40); }); }

    // init
    checkOrientationAndPrompt();
    setupGestureLock();
    window.addEventListener('orientationchange', checkOrientationAndPrompt);
    window.addEventListener('resize', checkOrientationAndPrompt);

    // render & retry on load
    renderVisitorTable();
    retryUnsynced();

    // show first page
    showPage('pw');

    // focus first input
    visitorName.focus();
  </script>
</body>
</html>

